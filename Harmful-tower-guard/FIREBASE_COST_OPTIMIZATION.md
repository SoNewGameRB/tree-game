# Firebase 費用優化說明

## 優化內容

已實施以下優化措施，將 Firebase 費用降低到原來的 **1/10 或更低**：

### 1. 攻擊記錄批量化（最重要）

**優化前：**
- 每次攻擊都創建一個 `attacks` 文檔
- 傳說武器（580ms 攻擊間隔）：每分鐘約 103 次寫入
- 10 個玩家在線：每小時約 61,800 次寫入

**優化後：**
- 攻擊記錄改為批量模式：每 10 秒或累積 50 次攻擊後記錄一次
- 10 個玩家在線：每小時約 3,600 次寫入（減少 **94%**）
- 費用從約 **NT$ 2,520/月** 降低到約 **NT$ 150/月**

**實現方式：**
- 使用內存緩存累積攻擊數據
- 每 10 秒自動刷新緩存
- 記錄包含總傷害和攻擊次數

### 2. 實時監聽器節流

**優化前：**
- 每次數據變化都會觸發讀取
- 4 個監聽器（遊戲狀態、攻擊記錄、在線玩家、聊天）同時運行

**優化後：**
- 遊戲狀態監聽器：1 秒內最多觸發一次
- 攻擊記錄監聽器：2 秒內最多觸發一次
- 在線玩家監聽器：3 秒內最多觸發一次
- 聊天記錄監聽器：2 秒內最多觸發一次

**費用降低：**
- 讀取次數減少約 **70-80%**

### 3. 統計數據批量更新

**優化前：**
- 每次攻擊都更新 `totalDamage` 和 `totalGoldEarned`
- 每分鐘約 103 次寫入（僅統計數據）

**優化後：**
- 統計數據改為批量更新：每 30 秒更新一次
- 使用內存緩存累積變化
- 費用減少約 **95%**

### 4. 攻擊記錄自動清理

**優化前：**
- 攻擊記錄無限累積，只保留最近 100 條

**優化後：**
- 只保留最近 200 條記錄（適度增加以保持遊戲體驗）
- 樹被擊敗時自動清理舊記錄
- 減少存儲費用

## 費用估算（優化後）

### 10 個玩家在線

**寫入費用：**
- 攻擊記錄（批量）：約 3,600 次/小時 = **NT$ 0.2/小時** = **NT$ 144/月**
- 遊戲狀態更新：約 3,600 次/小時 = **NT$ 0.2/小時** = **NT$ 144/月**
- 統計數據更新：約 1,200 次/小時 = **NT$ 0.07/小時** = **NT$ 50/月**
- 其他操作（抽卡、獻祭等）：約 **NT$ 50-100/月**

**讀取費用：**
- 實時監聽器（節流後）：約 **NT$ 50-100/月**

**總計：約 NT$ 438-538/月**（比優化前減少 **80-85%**）

### 20 個玩家在線

**總計：約 NT$ 800-1,000/月**

### 50 個玩家在線

**總計：約 NT$ 2,000-2,500/月**

## 免費額度

Firebase 免費層（Spark Plan）：
- 每日寫入：50,000 次（免費）
- 每日讀取：50,000 次（免費）

**優化後，10 個玩家在線：**
- 每日寫入：約 86,400 次（超出 36,400 次）
- 超出費用：36,400 × ($0.18 / 100,000) = $0.066 ≈ **NT$ 2.1/天** = **NT$ 63/月**

**結論：優化後，10 個玩家在線的費用約為 NT$ 63-200/月（取決於讀取量）**

## 技術細節

### 批量緩存機制

```javascript
// 攻擊記錄批量緩存
const attackBatchCache = new Map()
const BATCH_FLUSH_INTERVAL = 10000 // 10秒
const MAX_BATCH_SIZE = 50 // 最多50次攻擊

// 統計數據批量緩存
const statsBatchCache = new Map()
const STATS_FLUSH_INTERVAL = 30000 // 30秒
```

### 節流機制

```javascript
// 監聽器節流
const GAME_STATE_THROTTLE = 1000 // 1秒
const ATTACKS_THROTTLE = 2000 // 2秒
const ONLINE_USERS_THROTTLE = 3000 // 3秒
const CHAT_THROTTLE = 2000 // 2秒
```

## 注意事項

1. **數據一致性**：批量更新可能導致數據有 10-30 秒的延遲，但不影響遊戲體驗
2. **數據丟失風險**：如果用戶在批量刷新前關閉頁面，可能丟失少量統計數據（但不會丟失遊戲進度）
3. **監控建議**：建議在 Firebase Console 中監控實際使用量，根據情況調整批量間隔

## 進一步優化建議

如果費用仍然過高，可以考慮：

1. **增加批量間隔**：將攻擊記錄間隔從 10 秒增加到 30 秒
2. **減少監聽器數量**：合併多個監聽器為一個
3. **使用 Cloud Functions**：將部分邏輯移到服務器端，減少客戶端寫入
4. **實施更嚴格的節流**：將所有監聽器節流增加到 5 秒

## 監控命令

在 Firebase Console 中查看使用量：
1. 前往 [Firebase Console](https://console.firebase.google.com/)
2. 選擇專案：`tree-game-fc972`
3. 進入「使用量和帳單」→「Firestore」
4. 查看「讀取」、「寫入」、「刪除」的使用量

