# ç®¡ç†å“¡æ¬Šé™è¨­ç½®èªªæ˜

## æ¦‚è¿°

å·²å¯¦ä½œæ–¹æ¡ˆä¸€ï¼šä¿®æ”¹ Firestore è¦å‰‡ï¼Œå…è¨±ç®¡ç†å“¡åˆªé™¤ç”¨æˆ¶è³‡æ–™ã€‚ç®¡ç†å“¡æ¬Šé™é€šéæª¢æŸ¥ç”¨æˆ¶æ–‡æª”ä¸­çš„ `isAdmin` å­—æ®µä¾†åˆ¤æ–·ã€‚

## å¦‚ä½•æˆç‚ºç®¡ç†å“¡

### æ–¹æ³• 1ï¼šé€šéç®¡ç†å“¡å¯†ç¢¼ç™»å…¥ï¼ˆæ¨è–¦ï¼‰

1. åœ¨ç™»å…¥é é¢ï¼Œè¼¸å…¥ä½ æƒ³è¦ä½¿ç”¨çš„**ç®¡ç†å“¡åç¨±**
2. é»æ“Šã€ŒğŸ‘‘ ç³»çµ±ç®¡ç†å“¡ç™»å…¥ã€
3. è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼ˆé»˜èªç‚º `admin123`ï¼Œå¯é€šéç’°å¢ƒè®Šæ•¸ `VITE_ADMIN_PASSWORD` è¨­ç½®ï¼‰
4. ç³»çµ±æœƒè‡ªå‹•ï¼š
   - åœ¨ Firestore ä¸­è¨­ç½®è©²åç¨±çš„ç”¨æˆ¶ç‚ºç®¡ç†å“¡ï¼ˆ`isAdmin: true`ï¼‰
   - ä½¿ç”¨è©²åç¨±é€²è¡Œæ­£å¸¸ç™»å…¥ï¼ˆç²å¾— Firebase èªè­‰ï¼‰
   - é€™æ¨£ä½ å°±å¯ä»¥é€šé Firestore è¦å‰‡æª¢æŸ¥ä¾†åŸ·è¡Œç®¡ç†å“¡æ“ä½œ

### æ–¹æ³• 2ï¼šé€šé Email è‡ªå‹•è¨­ç½®ï¼ˆå¦‚æœä½¿ç”¨ Google ç™»å…¥ï¼‰

å¦‚æœç³»çµ±æ”¯æ´ Google ç™»å…¥ï¼Œç•¶ç”¨æˆ¶çš„ email åœ¨ `src/utils/admin.js` çš„ `ADMIN_EMAILS` åˆ—è¡¨ä¸­æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•è¨­ç½® `isAdmin: true`ã€‚

## è¨­ç½®æ­¥é©Ÿ

### 1. æ›´æ–° Firestore è¦å‰‡

å‰å¾€ Firebase Console â†’ Firestore Database â†’ è¦å‰‡ï¼Œä½¿ç”¨ `FIRESTORE_RULES.md` ä¸­æ›´æ–°çš„è¦å‰‡ï¼š

é—œéµè®Šæ›´ï¼š
- æ·»åŠ äº† `isAdmin()` è¼”åŠ©å‡½æ•¸ä¾†æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
- ä¿®æ”¹ `users` é›†åˆçš„ `delete` è¦å‰‡ï¼Œå…è¨± `isAdmin: true` çš„ç”¨æˆ¶åˆªé™¤ä»»ä½•ç”¨æˆ¶æ–‡æª”

```javascript
// ç”¨æˆ¶è³‡æ–™ - ç®¡ç†å“¡å¯ä»¥åˆªé™¤
match /users/{userId} {
  allow read: if true;
  allow create: if request.auth != null 
    && request.auth.uid == userId;
  allow update: if request.auth != null 
    && request.auth.uid == userId;
  // å…è¨±ç®¡ç†å“¡åˆªé™¤ä»»ä½•ç”¨æˆ¶è³‡æ–™
  allow delete: if isAdmin() || (request.auth != null && request.auth.uid == userId);
}
```

### 2. è¨­ç½®ç®¡ç†å“¡å¯†ç¢¼ï¼ˆå¯é¸ï¼‰

åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„çš„ `.env` æ–‡ä»¶ä¸­è¨­ç½®ï¼š

```env
VITE_ADMIN_PASSWORD=ä½ çš„ç®¡ç†å“¡å¯†ç¢¼
```

å¦‚æœä¸è¨­ç½®ï¼Œé»˜èªå¯†ç¢¼ç‚º `admin123`ã€‚

### 3. ç®¡ç†å“¡ç™»å…¥æµç¨‹

1. **é¦–æ¬¡è¨­ç½®ç®¡ç†å“¡**ï¼š
   - è¼¸å…¥ä½ æƒ³è¦çš„ç®¡ç†å“¡åç¨±ï¼ˆä¾‹å¦‚ï¼š`admin`ï¼‰
   - é»æ“Šã€ŒğŸ‘‘ ç³»çµ±ç®¡ç†å“¡ç™»å…¥ã€
   - è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼
   - ç³»çµ±æœƒè‡ªå‹•å‰µå»ºè©²ç”¨æˆ¶ä¸¦è¨­ç½®ç‚ºç®¡ç†å“¡

2. **ä¹‹å¾Œç™»å…¥**ï¼š
   - ç›´æ¥ä½¿ç”¨è©²ç®¡ç†å“¡åç¨±é€²è¡Œæ­£å¸¸ç™»å…¥å³å¯
   - ç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥ä½ ç‚ºç®¡ç†å“¡ï¼ˆå› ç‚ºä½ çš„ç”¨æˆ¶æ–‡æª”ä¸­æœ‰ `isAdmin: true`ï¼‰

## ç®¡ç†å“¡åŠŸèƒ½

ç®¡ç†å“¡å¯ä»¥åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **æ¸…é™¤æ‰€æœ‰ç©å®¶è³‡æ–™**ï¼šåœ¨éŠæˆ²é é¢çš„ç®¡ç†å“¡é¢æ¿ä¸­ï¼Œé»æ“Šã€ŒğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç©å®¶è³‡æ–™ã€æŒ‰éˆ•
   - æ­¤æ“ä½œæœƒåˆªé™¤ Firestore ä¸­æ‰€æœ‰ç”¨æˆ¶çš„æ–‡æª”
   - éœ€è¦å…©æ¬¡ç¢ºèªä»¥é˜²æ­¢èª¤æ“ä½œ
   - åªæœ‰é€šé Firebase èªè­‰ä¸” `isAdmin: true` çš„ç”¨æˆ¶æ‰èƒ½åŸ·è¡Œ

## æŠ€è¡“èªªæ˜

### Firestore è¦å‰‡æª¢æŸ¥

Firestore è¦å‰‡ä½¿ç”¨ä»¥ä¸‹é‚è¼¯æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™ï¼š

```javascript
function isAdmin() {
  return request.auth != null 
    && exists(/databases/$(database)/documents/users/$(request.auth.uid))
    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
}
```

é€™æ„å‘³è‘—ï¼š
- ç”¨æˆ¶å¿…é ˆå·²é€šé Firebase èªè­‰ï¼ˆ`request.auth != null`ï¼‰
- ç”¨æˆ¶çš„ Firestore æ–‡æª”å¿…é ˆå­˜åœ¨
- ç”¨æˆ¶æ–‡æª”ä¸­çš„ `isAdmin` å­—æ®µå¿…é ˆç‚º `true`

### é‡è¦æ³¨æ„äº‹é …

1. **å¿…é ˆé€šé Firebase èªè­‰**ï¼šåªæœ‰é€šé Firebase èªè­‰çš„ç”¨æˆ¶æ‰èƒ½é€šé Firestore è¦å‰‡æª¢æŸ¥ã€‚ç®¡ç†å“¡é€šéå¯†ç¢¼ç™»å…¥æ™‚ï¼Œç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨ç®¡ç†å“¡åç¨±é€²è¡Œ Firebase åŒ¿åèªè­‰ï¼Œé€™æ¨£æ‰èƒ½é€šéè¦å‰‡æª¢æŸ¥ã€‚

2. **ç®¡ç†å“¡æ¨™è¨˜å­˜å„²åœ¨ Firestore**ï¼š`isAdmin` å­—æ®µå­˜å„²åœ¨ç”¨æˆ¶çš„ Firestore æ–‡æª”ä¸­ï¼Œè¦å‰‡æœƒè®€å–é€™å€‹å­—æ®µä¾†åˆ¤æ–·æ¬Šé™ã€‚

3. **å®‰å…¨æ€§**ï¼šç®¡ç†å“¡å¯†ç¢¼æ‡‰è©²è¨­ç½®ç‚ºå¼·å¯†ç¢¼ï¼Œä¸¦ä¸”ä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»çµ±ã€‚

## æ•…éšœæ’é™¤

### å•é¡Œï¼šæ¸…é™¤è³‡æ–™æ™‚å‡ºç¾ã€ŒMissing or insufficient permissionsã€éŒ¯èª¤

**åŸå› **ï¼šä½ æ²’æœ‰é€šé Firebase èªè­‰ï¼Œæˆ–è€…ä½ çš„ç”¨æˆ¶æ–‡æª”ä¸­ `isAdmin` å­—æ®µä¸æ˜¯ `true`ã€‚

**è§£æ±ºæ–¹æ³•**ï¼š
1. ç¢ºèªä½ ä½¿ç”¨ç®¡ç†å“¡åç¨±é€²è¡Œæ­£å¸¸ç™»å…¥ï¼ˆä¸æ˜¯é€šéå¯†ç¢¼ç™»å…¥å‰µå»ºçš„å‡ç”¨æˆ¶å°è±¡ï¼‰
2. ç¢ºèª Firestore è¦å‰‡å·²æ­£ç¢ºæ›´æ–°
3. æª¢æŸ¥ä½ çš„ç”¨æˆ¶æ–‡æª”ä¸­æ˜¯å¦æœ‰ `isAdmin: true` å­—æ®µ

### å•é¡Œï¼šå¦‚ä½•ç¢ºèªæˆ‘å·²ç¶“æ˜¯ç®¡ç†å“¡ï¼Ÿ

åœ¨ Firebase Console ä¸­æŸ¥çœ‹ä½ çš„ç”¨æˆ¶æ–‡æª”ï¼Œç¢ºèª `isAdmin` å­—æ®µç‚º `true`ã€‚

### å•é¡Œï¼šå¦‚ä½•å–æ¶ˆç®¡ç†å“¡æ¬Šé™ï¼Ÿ

åœ¨ Firebase Console ä¸­æ‰‹å‹•å°‡ç”¨æˆ¶æ–‡æª”çš„ `isAdmin` å­—æ®µè¨­ç½®ç‚º `false` æˆ–åˆªé™¤è©²å­—æ®µã€‚

